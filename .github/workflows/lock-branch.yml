name: Lock Main/Master Branch

on:
  workflow_dispatch:

jobs:
  lock-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Lock the branch
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GHA_PAT_TOKEN }}
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            if (branchName === 'main' || branchName === 'master') {
              try {
                // Get the current protection settings
                const { data: protection } = await github.rest.repos.getBranchProtection({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: branchName
                });

                // Update protection settings to include branch lock
                await github.rest.repos.updateBranchProtection({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  branch: branchName,
                  required_status_checks: protection.required_status_checks || null,
                  enforce_admins: protection.enforce_admins || { enabled: true },
                  required_pull_request_reviews: {
                    ...protection.required_pull_request_reviews
                  },
                  restrictions: protection.restrictions || null,
                  lock_branch: true  // Lock the branch
                });

                console.log('Branch locked:', branchName);
              } catch (error) {
                if (error.status === 404) {
                  // Create branch protection with locking if it does not exist
                  await github.rest.repos.updateBranchProtection({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    branch: branchName,
                    required_status_checks: null,
                    enforce_admins: true,
                    required_pull_request_reviews: {
                      dismissal_restrictions: {},
                      dismiss_stale_reviews: false,
                      require_code_owner_reviews: true,
                      required_approving_review_count: 1
                    },
                    restrictions: null,  // Do not include restrictions for non-organization repositories
                    lock_branch: true  // Lock the branch
                  });

                  console.log('Branch protection added and branch locked:', branchName);
                } else {
                  throw error;
                }
              }
            } else {
              console.log('Branch not locked as it is not main or master:', branchName);
            }
